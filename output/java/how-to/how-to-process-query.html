<!DOCTYPE html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link type="text/css" rel="stylesheet" href="/resources/site.css" />
    <script src="/resources/space.js" type="text/javascript"></script>
    <meta name="keywords" content="CMIS, Content Management Interoperability Service, ECM, Enterprise Content Management, OASIS, integration standards, Chemistry, OpenCMIS, cmislib, DotCMIS, PortCMIS, ObjectiveCMIS" />
    <meta name="description" content="Apache Chemistry, CMIS Implementation" />
    <link rel="shortcut icon" href="/favicon.ico">
    <title>Apache Chemistry - Query Integration</title>
    <style>
.headerlink {
    visibility: hidden;
}
dt:hover > .headerlink, p:hover > .headerlink, td:hover > .headerlink, h1:hover > .headerlink, h2:hover > .headerlink, h3:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, h6:hover > .headerlink {
    visibility: visible;
}
    </style>
  </head>
<body onload="init()">
  <table width="100%" cellpadding="0" cellspacing="0">
    <tr width="100%">
      <td id="cell-0-0">&nbsp;</td>
      <td id="cell-0-1">&nbsp;</td>
      <td id="cell-0-2">&nbsp;</td>
    </tr>
    <tr width="100%">
      <td id="cell-1-0">&nbsp;</td>
      <td id="cell-1-1">
        <div id="banner" style="padding: 0px;">
          <!-- Banner -->
          <A href="https://chemistry.apache.org/" title="Apache Chemistry">
            <IMG src="/images/chemistry_tm_logo.png" style="float:left; border:0px;"/>
          </A>
          <A href="https://www.apache.org/" title="The Apache Software Foundation">
            <IMG src="/images/asf-logo.png"  style="float:right; border:0px;"/>
           </A>
          <!-- Banner -->
        </div>
        <div id="top-menu">
          <table border="0" cellpadding="1" cellspacing="0" width="100%">
            <tr>
              <td>
                <div align="left">
                <!-- Breadcrumbs -->
<a href="/">Home</a>&nbsp;&raquo&nbsp;<a href="/java/">Java</a>&nbsp;&raquo&nbsp;<a href="/java/how-to/">How-to</a>&nbsp;&raquo&nbsp;<a href="#">Query Integration</a>
                <!-- Breadcrumbs -->
                </div>
              </td>
              <td>
                <div align="right">
                <!-- Quicklinks -->
<P>
<A href="https://www.apache.org/" class="external-link" rel="nofollow">Apache</A>
|
<A href="https://www.apache.org/licenses/LICENSE-2.0.html" class="external-link" rel="nofollow">License</A>
</P>
                <!-- Quicklinks -->
                </div>
              </td>
            </tr>
          </table>
        </div>
      </td>
      <td id="cell-1-2">&nbsp;</td>
    </tr>
    <tr width="100%">
      <td id="cell-2-0">&nbsp;</td>
      <td id="cell-2-1">
        <table>
          <tr height="100%" valign="top">
            <td height="100%">
              <div id="wrapper-menu-page-right">
                <div id="wrapper-menu-page-top">
                  <div id="wrapper-menu-page-bottom">
                    <div id="menu-page">
                      <!-- NavigationBar -->

<H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
   <LI><A href="/project/cmis.html" title="What's CMIS">What is CMIS?</A></LI>
   <LI><A href="https://www.apache.org/licenses/" class="external-link" rel="nofollow">License</A></LI>
   <LI><A href="/project/community.html" title="Community">Community</A></LI>
   <LI><A href="https://lists.apache.org/list.html?dev@chemistry.apache.org" class="external-link" rel="nofollow">Mailing List</A></LI>
   <LI><A href="https://issues.apache.org/jira/browse/CMIS" class="external-link" rel="nofollow">Issue Tracking</A></LI>
   <LI><A href="https://www.apache.org/security/" class="external-link" rel="nofollow">Security</A></LI>
</UL>


<H3><A name="Navigation-Search"></A>Search</H3>

<DIV style="padding: 0px 0px 0px 20px;">
<FORM action="https://www.google.com/search" method="get" style="font-size: 10px;">
<INPUT name="ie" type="hidden" value="UTF-8"></INPUT>
<INPUT name="oe" type="hidden" value="UTF-8"></INPUT>
  <INPUT maxlength="255" name="q" size="12" type="text" value=""></INPUT>
  <INPUT name="btnG" type="submit" value="Search"></INPUT>
  <INPUT name="domains" type="hidden" value="chemistry.apache.org"></INPUT>
  <INPUT name="sitesearch" type="hidden" value="chemistry.apache.org"></INPUT>
</FORM>
</DIV>


<H3><A name="Navigation-CMISforJava"></A>CMIS for Java</H3>

<UL class="alternate" type="square">
  <LI><A href="/java/opencmis.html" title="OpenCMIS Overview and Index">Overview</A></LI>
  <LI><A href="/java/download.html" title="Downloads">Downloads</A></LI>
  <LI><A href="/docs/cmis-samples/" title="Downloads">Code Samples</A></LI>
  <LI><A href="/java/javadoc">JavaDoc</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/opencmis/trunk/" class="external-link" rel="nofollow">Source Code</A></LI>
</UL>


<H3><A name="Navigation-CMISforPython"></A>CMIS for Python</H3>

<UL class="alternate" type="square">
  <LI><A href="/python/cmislib.html" title="cmislib">cmislib</A></LI>
  <LI><A href="/python/docs/" rel="nofollow">cmislib Documentation</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/cmislib/trunk/" class="external-link" rel="nofollow">Source Code</A></LI>
</UL>


<H3><A name="Navigation-CMISforPHP"></A>CMIS for PHP</H3>

<UL class="alternate" type="square">
  <LI><A href="/php/phpclient.html" title="phpclient">CMIS PHP Client</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/phpclient/trunk/" class="external-link" rel="nofollow">Source Code</A></LI>
</UL>


<H3><A name="Navigation-CMISfor.NET"></A>CMIS for .NET</H3>

<UL class="alternate" type="square">
  <LI><A href="/dotnet/dotcmis.html" title="DotCMIS">DotCMIS</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/dotcmis/trunk/" class="external-link" rel="nofollow">DotCMIS Source Code</A></LI>
  <LI><A href="/dotnet/portcmis.html" title="PortCMIS">PortCMIS</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/portcmis/trunk/" class="external-link" rel="nofollow">PortCMIS Source Code</A></LI>
  <LI><A href="/docs/cmis-samples/" title="Downloads">Code Samples</A></LI>
</UL>


<H3><A name="Navigation-CMISforObjective-C"></A>CMIS for Objective-C</H3>

<UL class="alternate" type="square">
  <LI><A href="/objective-c/objectivecmis.html" title="ObjectiveCMIS">ObjectiveCMIS</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/objectivecmis/trunk/" class="external-link" rel="nofollow">Source Code</A></LI>
</UL>

<H3><A name="Navigation-CMISforJavaScript"></A>CMIS for JavaScript</H3>

<UL class="alternate" type="square">
  <LI><A href="/javascript/parts.html" title="Chemistry Parts">Chemistry Parts</A></LI>
  <LI><A href="https://svn.apache.org/repos/asf/chemistry/parts/trunk/" class="external-link" rel="nofollow">Source Code</A></LI>
</UL>


<H3><A name="Navigation-Sponsorship"></A>Sponsorship</H3>

<UL class="alternate" type="square">
   <LI><A href="https://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">Thanks</A></LI>
   <LI><A href="https://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">Sponsoring Apache</A></LI>
</UL>


<H3><A name="Navigation-Internal"></A>Internal Docs</H3>

<UL class="alternate" type="square">
   <LI><A href="/internal/internal-index.html" rel="nofollow"> Internal Documentation</A></LI>
</UL>
                    <!-- NavigationBar -->
                    </div>
                </div>
              </div>
            </div>
           </td>
           <td height="100%">
             <!-- Content -->
             <div class="wiki-content">    <div id="toc"><ul><li><a class="toc-href" href="#opencmis-query-integration" title="OpenCMIS Query Integration">OpenCMIS Query Integration</a><ul><li><a class="toc-href" href="#implement-query-in-the-discovery-service" title="Implement query in the discovery service">Implement query in the discovery service</a></li><li><a class="toc-href" href="#use-built-in-antlr-and-antlr-cmisql-grammar" title="Use built-in ANTLR and ANTLR CMISQL grammar">Use built-in ANTLR and ANTLR CMISQL grammar</a></li><li><a class="toc-href" href="#use-opencmis-cmsiql-grammar-and-integrate-into-antlr-query-walker" title="Use OpenCMIS CMSIQL grammar and integrate into ANTLR query walker">Use OpenCMIS CMSIQL grammar and integrate into ANTLR query walker</a></li><li><a class="toc-href" href="#use-predefined-query-walker" title="Use predefined query walker">Use predefined query walker</a></li><li><a class="toc-href" href="#using-queryobject" title="Using QueryObject">Using QueryObject</a></li><li><a class="toc-href" href="#processing-a-node-and-referencing-types-and-properties" title="Processing a node and referencing types and properties">Processing a node and referencing types and properties</a></li><li><a class="toc-href" href="#building-the-result-list" title="Building the result list">Building the result list</a></li><li><a class="toc-href" href="#limitations" title="Limitations">Limitations</a></li></ul></li></ul></div>
<h1 id="opencmis-query-integration">OpenCMIS Query Integration<a class="headerlink" href="#opencmis-query-integration" title="Permalink">&para;</a></h1>
<p>The CMIS standard contains a powerful query language that supports full
text and relational metadata query capabilities and is modeled along a
subset of SQL. Many repositories will have the demand to integrate into
this query interface. OpenCMIS provides support to make a query integration
easier. This article explains the various hooks that are provided to
integrate into the query interface. These hooks provide different levels of
comfort and flexibility. OpenCMIS integrates a query parser that uses ANTLR
as parsing engine. However there is no strong dependency on ANTLR. If you
prefer a different language parsing tool it is possible to do this.</p>
<p>There are four different levels how you can integrate query:</p>
<ol>
<li>Implement query in the discovery service</li>
<li>Use the built-in ANTLR and ANTLR CMISQL grammar</li>
<li>Use OpenCMIS CMISQL grammar and integrate into ANTLR query walker</li>
<li>Use predefined query walker and integrate into interface <code>PredicateWalker</code>.</li>
</ol>
<h2 id="implement-query-in-the-discovery-service">Implement query in the discovery service<a class="headerlink" href="#implement-query-in-the-discovery-service" title="Permalink">&para;</a></h2>
<p>The first way is to implement the <code>query()</code> method like any other service
method on your own. This gives you the maximum flexibility including using
a parser tool of your choice and extensions of the query grammar as you
like. This is also the method with the highest implementation effort.</p>
<h2 id="use-built-in-antlr-and-antlr-cmisql-grammar">Use built-in ANTLR and ANTLR CMISQL grammar<a class="headerlink" href="#use-built-in-antlr-and-antlr-cmisql-grammar" title="Permalink">&para;</a></h2>
<p>OpenCMIS comes with a build-in integration of ANTLR and provides a grammar
file for CMISQL. You can reuse this grammar file, modify or extend it and
integrate query by using the ANTLR mechanisms for parsing and walking the
abstract syntax tree. Please refer to the ANTLR documentation for further
information. This is the right level to use if you need custom parser tree
transformations or would like to extend the grammar with your own
constructs. For demonstration purposes OpenCMIS provides an extended
grammar as an example.</p>
<h2 id="use-opencmis-cmsiql-grammar-and-integrate-into-antlr-query-walker">Use OpenCMIS CMSIQL grammar and integrate into ANTLR query walker<a class="headerlink" href="#use-opencmis-cmsiql-grammar-and-integrate-into-antlr-query-walker" title="Permalink">&para;</a></h2>
<p>If the standard CMISQL grammar is sufficient for you there is another level
of integration. For many repositories there are common tasks for processing
queries: The columns of the select part need to be evaluated and mapped to
type and property definitions. The from area needs to be mapped to type
definitions and some parts of the where part again refer to properties in
types. In addition all aliases defined in the statement need to be resolved
and many validations are performed. OpenCMIS provides a class that performs
these common tasks. You can make use of the resolved types, properties and
aliases and walk the resulting abstract syntax tree (AST) to evaluate the
query. You are free to walk the AST as many times as you need and in the
order you prefer. The basic idea is that the SELECT and FROM parts are
processed by OpenCMIS and you are responsible for the WHERE part. The
InMemory server provides an example for this level of integration: For
each object contained in the repository the tree is traversed and it's checked
if it matches the current query. You can take the InMemory code as an
example if you decide to use this integration level.</p>
<h2 id="use-predefined-query-walker">Use predefined query walker<a class="headerlink" href="#use-predefined-query-walker" title="Permalink">&para;</a></h2>
<p>For some repositories a simple and one-pass query traversal is sufficient.
This can be the case if for example your query needs to be translated to a
SQL query statement. Because ANTLR has some complexity OpenCMIS provides a
predefined walker that performs a simple one pass depth-first traversal. If
this is sufficient this interface hides most of the complexity of ANTLR.
All you have to do is to implement a Java interface
(<code>PredicateWalker</code>). You can refer to the InMemory server for example
code (<code>InMemoryWhereClauseWalker</code>).</p>
<p><code>AbstractPredicateWalker</code> implements interface <code>PredicateWalker</code> and
implements common functionality useful for traversing the tree. For example
parsing literals like <code>"abc"</code>, <code>-123</code> to Java objects like <code>String</code>
and <code>Integer</code> is handled there.</p>
<p>If the interface of the predefined walker <code>PredicateWalker</code> does not
fit your needs you can define your own interface. The code generated
by ANTLR does not make any assumptions how you design the walking of
your tree. The only dependency is contained in the interface
<code>PredicateWalkerBase</code> consisting of a single method. If you start
defining your own walker you have to implement or extend <code>PredicateWalkerBase</code>.
The unit tests contain an example for this. See class <code>QueryConditionProcessor</code>
in the unit tests for the InMemory server.</p>
<p>Note: There is currently no predefined walker for JOIN statements. If
you need to support JOINs you have to build your own walker for this part
as outlined in the previous section.</p>
<h2 id="using-queryobject">Using QueryObject<a class="headerlink" href="#using-queryobject" title="Permalink">&para;</a></h2>
<p>The class <code>QueryObject</code> provides all the basic functionality for resolving
types and properties and performs common validation tasks. The <code>QueryObject</code>
processes the <code>SELECT</code> and <code>FROM</code> parts as well as all property references from
the <code>WHERE</code> part. It maintains a list of Java objects and an interface that you
can use to access the property and type definitions given your current
position in the statement. For an example refer to the class
<code>StoreManagerImpl</code> of the InMemory Server and method <code>query()</code>.
To be able to use this object <code>QueryObj</code> needs to get access to the types contained in your
repository. For this purpose you need to pass an interface to a <code>TypeManager</code>
as input parameter. Your code will typically look like this:</p>
<pre><code class="language-java">	public class MyWalker extends AbstractPredicateWalker {
                             // extends AbstractPredicateWalker
                             // or implements interface PredicateWalker
							 // or implements interface PredicateWalkerBase
	  // . . .
	}

    TypeManager tm = new MyTypeManager(); // implements interface TypeManager
    MyWalker myWalker = new MyWalker();    
    queryObj = new QueryObject(tm);
    QueryUtil queryUtil = new QueryUtil();

    CmisQueryWalker queryProcessor = queryUtil.traverseStatementAndCatchExc(statement, queryObj, myWalker);
</code></pre>
<p><code>queryUtil</code> then will process the statement and call the interface methods of
your walker (Note: This code is in opencmis, you don't have to implement it
yourself.):</p>
<pre><code class="language-java">    try {
        walker = getWalker(statement);
        walker.query(queryObj, pw);
        return walker; 
	} catch (RecognitionException e) {
		String errorMsg = queryObj.getErrorMessage();
		throw new CmisInvalidArgumentException("Walking of statement failed with RecognitionException error: \n   " + errorMsg);
	} catch (CmisBaseException e) {
		throw e;
	} catch (Exception e) {
		throw new CmisInvalidArgumentException("Walking of statement failed with exception: \n   " + e);
    }
</code></pre>
<p>After this method returns you may for example ask your walker object
<code>myWalker</code> for the generated SQL string.</p>
<h2 id="processing-a-node-and-referencing-types-and-properties">Processing a node and referencing types and properties<a class="headerlink" href="#processing-a-node-and-referencing-types-and-properties" title="Permalink">&para;</a></h2>
<p>While traversing the tree you often will need to access the property and
type definitions that are referenced in the where clause. The <code>QueryObject</code>
provides the necessary information for resolving the references. For
example the statement</p>
<pre><code>`... WHERE x &lt; 123`
</code></pre>
<p>will result in calling the method <code>walkLessThan()</code> in your walker callback
implementation:</p>
<pre><code class="language-java">    public Boolean walkLessThan(Tree ltNode, Tree leftNode, Tree rightNode) {
    
        Object rVal = walkLiteral(rightChild);
        ColumnReference colRef;
    
        CmisSelector sel = queryObj.getColumnReference(columnNode
			     .getTokenStartIndex());
    
        if (null == sel)
           throw new CmisInvalidArgumentException("Unknown property query name " +
		          columnNode.getChild(0));
        else if (sel instanceof ColumnReference)
           colRef = (ColumnReference) sel;
    
       TypeDefinition td = colRef.getTypeDefinition();
       PropertyDefinition pd =
           td.getPropertyDefinitions().get(colRef.getPropertyId());
        
       // process the statement, for example append it to a WHERE
       // in your generated SQL statement.
    }
</code></pre>
<p>The right child node is a literal and you will get an Integer object with
value 123. The left node is a reference to a property and
<code>getColumnReference()</code> will either give you a function (currently the only
supported function is <code>SCORE()</code>) or a reference to a property in a type of
your type system. The query object maintains several maps to resolve
references. The key to the map is always the token index in the incoming
token stream (an integer value). You can get the token index for each node
by calling <code>getTokenStartIndex()</code> on the node.</p>
<h2 id="building-the-result-list">Building the result list<a class="headerlink" href="#building-the-result-list" title="Permalink">&para;</a></h2>
<p>After processing the query an <code>ObjectList</code> has to be returned containing the
requested properties and function results. You can ask the query object for
the requested information:</p>
<pre><code class="language-java">    Map props = queryObj.getRequestedProperties();
    Map funcs = queryObj.getRequestedFuncs();
</code></pre>
<p>Key of the map is the query name and value is the alias if an alias was
used in the statement or the query name otherwise.</p>
<h2 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permalink">&para;</a></h2>
<p>Currently the query parser does not include the full text search part
of the grammar. Support for JOIN is limited. This will be enhanced in a
future version</p>

</div>
             <!-- Content -->
           </td>
          </tr>
        </table>
     </td>
     <td id="cell-2-2">&nbsp;</td>
    </tr>
    <tr width="100%">
      <td id="cell-3-0">&nbsp;</td>
      <td id="cell-3-1">&nbsp;</td>
      <td id="cell-3-2">&nbsp;</td>
    </tr>
    <tr width="100%">
     <td id="cell-3-0">&nbsp;</td>
     <td id="cell-3-1">
       <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
          Apache Chemistry, Apache, the Apache feather logo, and the Apache 
          Chemistry project logo are trademarks of The Apache Software 
          Foundation.
          <br>
          Content Management Interoperability Services (CMIS) is an
          <a href="https://www.oasis-open.org/committees/cmis/">OASIS</a>
          specification.
       </div>
       <!-- Footer -->
       </div>
     </td>
     <td id="cell-3-2">&nbsp;</td>
    </tr>
    <tr width="100%">
      <td id="cell-4-0">&nbsp;</td>
      <td id="cell-4-1">&nbsp;</td>
      <td id="cell-4-2">&nbsp;</td>
    </tr>
  </table>
  <script type="text/javascript" src="/resources/retina.min.js"></script>
  <link rel="stylesheet" href="/resources/xcode.css">
  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</body>
</html>